<?xml version="1.0" encoding="utf-8"?>
<modification>
    <name>Attributico</name>
    <code>attributico_3</code>
    <version>3.2.8(oc v3.x)</version>
    <author>comtronics@mail.ru</author>
    <link>http://attributico.su</link>    

    <file path="admin/controller/common/column_left.php">
        <operation error="skip">
            <search><![CDATA[if ($attribute) {]]></search>
            <add position="before"><![CDATA[
                if ($this->user->hasPermission('access', 'extension/module/attributico')) {
                    $attribute[] = array(
                        'name'	   => '<span> Attribut<b style="color: #2199C7;">&</b>co</span>',
                        'href'     => $this->url->link('extension/module/attributico', 'user_token=' . $this->session->data['user_token'], true),
                        'children' => array()
                    );
                }
            ]]>            </add>
        </operation>
    </file>

    <file path="admin/view/template/catalog/category_form.twig">
        <operation>
            <ignoreif><![CDATA[<li><a href="#tab-attribute" data-toggle="tab">{{ tab_attribute }}</a></li>]]></ignoreif>
            <search><![CDATA[<li><a href="#tab-design" data-toggle="tab">{{ tab_design }}</a></li>]]></search>
            <add position="after" ><![CDATA[<li><a href="#tab-attribute" data-toggle="tab">{{ tab_attribute }}</a></li>]]></add>
        </operation>
        <operation>
            <ignoreif><![CDATA[<div class="tab-pane" id="tab-attribute">]]></ignoreif>
            <search index='1'><![CDATA[</table>]]></search>
            <add position="after" offset="2"><![CDATA[
            <div class="tab-pane" id="tab-attribute">
              <div class="form-group">
                <label class="col-sm-2 control-label" for="input-attribute"><span data-toggle="tooltip" title="{{ category_description[language_id].name }}">{{ entry_attribute }}</span></label>
                <div class="col-sm-10">                 
                  <div id="category-attribute" class="well well-sm" style="height: 150px; overflow: auto;">
                    {% for category_attribute in category_attributes %}
                    <div id="category-attribute{{ category_attribute.attribute_id }}"><i class="fa fa-minus-circle"></i> {{ category_attribute.name }}
                      <input type="hidden" name="category_attribute[]" value="{{category_attribute.attribute_id}}" />
                    </div>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>
            ]]></add>
        </operation>        
    </file>

    <file path="admin/controller/catalog/category.php">
        <operation>
            <ignoreif><![CDATA[$this->load->model('catalog/attributipro');]]></ignoreif>
            <search><![CDATA[$this->load->model('catalog/category');]]></search>
            <add position="after"><![CDATA[$this->load->model('catalog/attributico');]]></add>
        </operation>        
        <operation>
            <ignoreif><![CDATA[$this->load->model('catalog/attributipro');]]></ignoreif>
            <search><![CDATA[$this->load->model('setting/store');]]></search>
            <add position="before"><![CDATA[
        $data['language_id'] = $this->config->get('config_language_id'); 
        $data['entry_attribute'] = $this->language->get('tab_attribute');   
		$this->load->model('catalog/attribute');
		$this->load->model('catalog/attributico');

		if (isset($this->request->post['category_attribute'])) {
                    $attributes = $this->request->post['category_attribute'];
		} elseif (isset($this->request->get['category_id'])) {
                    $sortOrder = $this->config->get('attributico_sortorder') == '1' ? true : false;
                    $filter_data = array(
                        'category_id' => (int) $this->request->get['category_id'],
                        'sort' => $sortOrder ? 'sort_attribute_group, a.sort_order' : ''
                    );
                    $attributes = $this->model_catalog_attributico->getCategoryAttributes($filter_data);
		} else {
                    $attributes = array();
		}

		$data['category_attributes'] = array();
		foreach ($attributes as $result) {
                    $attribute_info = $this->model_catalog_attribute->getAttribute($result['attribute_id']);
                    if ($attribute_info) {
                        $data['category_attributes'][] = array(
                            'attribute_id' => $attribute_info['attribute_id'],
                            'name'      => $attribute_info['name']
                        );
                    }
		}
		]]>
            </add>
        </operation>
    </file>

    <file path="admin/view/template/catalog/product_form.twig">        
        <operation error="skip">            
            <search><![CDATA[{{ footer }}]]></search>
            <add position="before"><![CDATA[<script src="view/javascript/attributico/attributico-product.js" type="text/javascript"></script>]]></add>
        </operation>        
        <operation>
            <ignoreif><![CDATA[html += '  <td class="text-left" style="width: 5%;"><input type="text" value="" class="form-control" readonly="true"/></td>';]]></ignoreif>
            <search><![CDATA[html += '  <td class="text-left">';]]></search>
            <add position="before"><![CDATA[
                html += '  <td class="text-left" style="width: 5%;"><input type="text" value="" class="form-control" readonly="true"/></td>';
            ]]></add>
        </operation>
         <operation>
            <ignoreif><![CDATA[let old_id = $('input[name=\'product_attribute[' + attribute_row + '][attribute_id]\']').val();]]></ignoreif>
            <search><![CDATA[$('input[name=\'product_attribute[' + attribute_row + '][name]\']').val(item['label']);]]></search>
            <add position="before"><![CDATA[
                let old_id = $('input[name=\'product_attribute[' + attribute_row + '][attribute_id]\']').val();                
            ]]>            </add>
        </operation>
        <operation>
            <ignoreif><![CDATA[selectAttributeAutocomplete(attribute_row, old_id, item)]]></ignoreif>
            <search><![CDATA[$('input[name=\'product_attribute[' + attribute_row + '][attribute_id]\']').val(item['value']);]]></search>
            <add position="after"><![CDATA[selectAttributeAutocomplete(attribute_row, old_id, item)]]></add>
        </operation>        
        <operation error="skip">
            <ignoreif><![CDATA[<label id="group-name{{attribute_row}}">{{ product_attribute['group_name'] }}</label>]]></ignoreif>
            <search><![CDATA[<td class="text-left" style="width: 40%;">]]></search>
            <add position="replace"><![CDATA[<td class="text-left" style="width: 40%;"><label id="group-name{{attribute_row}}">{{ product_attribute['group_name'] }}</label>                        
            ]]></add>
        </operation>
        <operation error="skip">
            <ignoreif><![CDATA[<td class="text-left" style="width: 5%;"><input type="text" value="{{ product_attribute['sort_order'] }}" class="form-control" readonly="true"/></td>]]></ignoreif>
            <search index='0'><![CDATA[<input type="hidden" name="product_attribute[{{ attribute_row }}][attribute_id]" value="{{ product_attribute.attribute_id }}"/></td>]]></search>
            <add position="after"><![CDATA[<td class="text-left" style="width: 5%;"><input type="text" value="{{ product_attribute['sort_order'] }}" class="form-control" readonly="true"/></td>
            ]]></add>
        </operation>
        <operation error="skip">
            <ignoreif><![CDATA[<td class="text-left" style="width: 5%;"><input type="text" value="{{ product_attribute['sort_order'] }}" class="form-control" readonly="true"/></td>]]></ignoreif>
            <search index='0'><![CDATA[<input type="hidden" name="product_attribute[{{ attribute_row }}][attribute_id]" value="{{ product_attribute.attribute_id }}" /></td>]]></search>
            <add position="after"><![CDATA[<td class="text-left" style="width: 5%;"><input type="text" value="{{ product_attribute['sort_order'] }}" class="form-control" readonly="true"/></td>
            ]]></add>
        </operation>
        <operation error="skip">
            <search><![CDATA[<td class="text-left">{{ entry_attribute }}</td>]]></search>
            <add position="replace"><![CDATA[
                <td class="text-left">{{ entry_attribute }}
                    <button type='button' id='attach-attribute' class='btn btn-success pull-right'><i class='fa fa-plus'></i> {{ tab_attribute }}</button>
                </td>
                <td class="text-left">{{ entry_sort_order }}</td>
            ]]>            </add>
        </operation>
        <operation error="skip">
            <search><![CDATA[<td class="text-left">{{ entry_text }}</td>]]></search>
            <add position="replace"><![CDATA[
                <td class="text-left">
                    {{ entry_text }}
                    <div id="serv-panel" class="pull-right form-inline">                        
                    </div>
                </td>
            ]]>            </add>
        </operation>
         <operation error="skip">
            <search><![CDATA[<td class="text-right"><button type="button" onclick="$('#attribute-row{{ attribute_row }}').remove();" data-toggle="tooltip" title="{{ button_remove }}" class="btn btn-danger"><i class="fa fa-minus-circle"></i></button></td>]]></search>
            <add position="replace"><![CDATA[<td class="text-right"><button type="button" onclick="product_attribute_id = product_attribute_id.filter(item=>item !== $('#attribute-row{{ attribute_row }}').find('[name *= attribute_id]').val()); $('#attribute-row{{ attribute_row }}').remove(); " data-toggle="tooltip" title="{{ button_remove }}" class="btn btn-danger"><i class="fa fa-minus-circle"></i></button></td>
            ]]></add>
        </operation> 
        <operation error="skip">
            <search><![CDATA[html += '  <td class="text-right"><button type="button" onclick="$(\'#attribute-row' + attribute_row + '\').remove();" data-toggle="tooltip" title="{{ button_remove }}" class="btn btn-danger"><i class="fa fa-minus-circle"></i></button></td>';]]></search>
            <add position="replace"><![CDATA[html += '  <td class="text-right"><button type="button" onclick="product_attribute_id = product_attribute_id.filter(item=>item !== $(\'#attribute-row' + attribute_row + '\').find(\'[name *= attribute_id]\').val()); $(\'#attribute-row' + attribute_row + '\').remove(); " data-toggle="tooltip" title="{{ button_remove }}" class="btn btn-danger"><i class="fa fa-minus-circle"></i></button></td>'
            ]]></add>
        </operation> 
        <operation error="skip">
            <search><![CDATA[function addAttribute() {]]></search> 
            <add position="replace"><![CDATA[function addAttribute(attribute_id='""') {
            ]]></add>
        </operation>     
        <operation error="skip">
            <search><![CDATA[<input type="hidden" name="product_attribute[' + attribute_row + '][attribute_id]" value="" /></td>';]]></search> 
            <add position="replace"><![CDATA[<input type="hidden" name="product_attribute[' + attribute_row + '][attribute_id]" value=' + attribute_id  + ' /></td>';
            ]]></add>
        </operation> 
    </file>
    <file path="admin/view/template/catalog/product_form.twig">
	    <operation error="skip">
            <ignoreif><![CDATA[newCategory(item['value']);]]></ignoreif>
            <search><![CDATA[+ item['label'] + '<input type="hidden" name="product_category[]" value="' + item['value'] + '" /></div>');]]></search>
            <add position="after"><![CDATA[newCategory(item['value']);]]></add>
	    </operation>
    </file>    
    <file path="admin/controller/catalog/product.php">
        <operation error="skip">
            <search><![CDATA[$data['footer'] = $this->load->controller('common/footer');]]></search>
            <add position="after"><![CDATA[
		        $data['extension'] = version_compare(VERSION, '2.3.0', '>=') ? "extension/" : "";                
            ]]></add>
        </operation>
        <operation error="skip">
            <ignoreif><![CDATA[$this->load->model('catalog/attributipro');]]></ignoreif>
            <search><![CDATA[$this->load->model('catalog/attribute');]]></search>
            <add position="after"><![CDATA[
		        $this->load->model('catalog/attributico');                
            ]]></add>
        </operation>      
        <operation error="skip">
            <ignoreif><![CDATA[
		        $attribute_info = $this->model_catalog_attributipro->getAttributeInfo($product_attribute['attribute_id'], $this->config->get('config_language_id'));
                ]]>
            </ignoreif>
            <search><![CDATA[$attribute_info = $this->model_catalog_attribute->getAttribute($product_attribute['attribute_id']);]]></search>
            <add position="replace"><![CDATA[
		        $attribute_info = $this->model_catalog_attributico->getAttributeInfo($product_attribute['attribute_id'], $this->config->get('config_language_id'));
            ]]></add>
        </operation>
        <operation error="skip">
            <ignoreif><![CDATA[,'sort_order' => $attribute_info['sort_order'],]]></ignoreif>
            <search><![CDATA['product_attribute_description' => $product_attribute['product_attribute_description']]]></search>
            <add position="after"><![CDATA[
		        ,'sort_order' => $attribute_info['sort_order'],
				'group_name'  => $attribute_info['group_name'],
                'product_id' => isset($this->request->get['product_id']) ? $this->request->get['product_id'] : 0,
                ]]>
            </add>
        </operation>
        <operation error="skip">
            <ignoreif><![CDATA[array_multisort($sort_order, SORT_ASC, $data['product_attributes']);]]></ignoreif>
            <search><![CDATA[// Options]]></search>
            <add position="before"><![CDATA[
		        $sort_order = array();
                foreach ($data['product_attributes'] as $key => $value) {
                    $sort_order[$key] = $value['sort_order'];
                }
                array_multisort($sort_order, SORT_ASC, $data['product_attributes']);
            ]]></add>
        </operation>
    </file>
    <file path="admin/model/catalog/attribute.php">
        <operation>
            <ignoreif><![CDATA[$this->db->query("UPDATE " . DB_PREFIX . "attribute_description SET name = '" . $this->db->escape($value['name'])]]></ignoreif>
            <search index='0'><![CDATA[$this->db->query("DELETE FROM " . DB_PREFIX . "attribute_description WHERE attribute_id = '" . (int)$attribute_id . "'");]]></search>
            <add position="replace"><![CDATA[]]></add>
        </operation>
        <operation>
            <ignoreif><![CDATA[$this->db->query("UPDATE " . DB_PREFIX . "attribute_description SET name = '" . $this->db->escape($value['name'])]]></ignoreif>
            <search index='1'><![CDATA[
                $this->db->query("INSERT INTO " . DB_PREFIX . "attribute_description SET attribute_id = '" . (int)$attribute_id . "', language_id = '" . (int)$language_id . "', name = '" . $this->db->escape($value['name']) . "'");
            ]]></search>
            <add position="replace"><![CDATA[
                $this->db->query("UPDATE " . DB_PREFIX . "attribute_description SET name = '" . $this->db->escape($value['name']) . "' WHERE attribute_id = '" . (int) $attribute_id . "' AND language_id = '" . (int) $language_id . "'");
            ]]></add>
        </operation>
    </file>
    <file path="admin/model/localisation/language.php">
        <operation error="skip">
            <ignoreif><![CDATA['directory'   => $result['directory']]]></ignoreif>
            <search><![CDATA['sort_order'  => $result['sort_order'],]]></search>
            <add position="after"><![CDATA[
                'image'       => $result['image'],
                'directory'   => $result['directory'],
            ]]></add>
        </operation>
    </file>
	
	<file path="admin/view/template/common/header.twig">
        <operation error="skip">
            <ignoreif><![CDATA[<link type="text/css" href="view/stylesheet/autocomplete.css" rel="stylesheet" media="screen" />]]></ignoreif>
            <search><![CDATA[<link type="text/css" href="view/stylesheet/stylesheet.css" rel="stylesheet" media="screen" />]]></search>
            <add position="after" ><![CDATA[<link type="text/css" href="view/stylesheet/autocomplete.css" rel="stylesheet" media="screen" />]]></add>
        </operation>        
    </file>	
	<file path="admin/controller/catalog/product.php">
        <operation error="skip">
            <search><![CDATA[$limit = 5;]]></search>
			<add position="replace"><![CDATA[$limit = 10000;]]></add>
        </operation>        
    </file>		
	<file path="admin/controller/catalog/attribute.php">
        <operation error="skip">
            <search><![CDATA['limit'       => 5]]></search>
			<add position="replace"><![CDATA['limit'       => 10000]]></add>
        </operation>        
    </file>	
	<file path="admin/controller/catalog/category.php">
        <operation error="skip">
            <search><![CDATA['limit'       => 5]]></search>
			<add position="replace"><![CDATA['limit'       => 10000]]></add>
        </operation>        
    </file>
</modification>